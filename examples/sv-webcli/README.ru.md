[English](README.md) | **Русский**

# sv-webcli

Это веб-приложение, которое может использоваться в качестве альтернативы `/webcli`.
Оно предоставляет возможность напрямую взаимодействовать с RCI API или запустить
полноценную CLI-сессию прямо в браузере. Еще одна полезная функция — возможность
просматривать журнал устройства в отдельной панели во время работы с устройством.

Это приложение построено на [Svelte 5](https://svelte.dev/) и [dockview](https://dockview.dev/).

https://github.com/user-attachments/assets/dfe21a22-4079-4782-b104-39dd297f257d

- **Веб-терминал**: Полноценный эмулятор терминала на базе [ttyd](https://github.com/tsl0922/ttyd)
  и [xterm.js](https://xtermjs.org/).
- **Вкладка REST API**: Позволяет отправлять GET/POST/DELETE HTTP-запросы к эндпоинтам `/rci/` (и хранит историю запросов)
- **Просмотр журнала**: Боковая панель для просмотра журнала устройства с возможностью фильтрации

## Предварительные настройки

- Установить Node.js (v22 или выше)
- Установить менеджер пакетов `pnpm`
- Настроить SSH-доступ к целевому устройству
- (для SSH по паролю) установить `sshpass`

## Установка

```bash
# Из корня проекта
pnpm install
```

## Запуск приложения

### Режим разработки

Запустите сервер разработки

```bash
pnpm dev --device-addr <IP_ADDRESS>
```

Сервер разработки работает на `http://localhost:5174` и проксирует `/rci/`- и `/auth`-запросы на устройство.

**Опции:**
- `--device-addr <IP>` - **Обязательно**: IP-адрес устройства
- `--http-port <PORT>` - HTTP-порт для backend-сервиса (по умолчанию: 8081)

**Пример:**
```bash
pnpm dev --device-addr 192.168.1.1 --http-port 8081
```

### Сборка для продакшена

Соберите приложение для продакшена:

```bash
pnpm build
```

Результат будет в директории `dist`.

## Развертывание

### Настройка backend

Настройте backend устройства (устанавливает необходимые пакеты, настраивает lighttpd, ttyd):

```bash
pnpm configure-backend --device-addr <IP_ADDRESS>
```

Этот скрипт:
1. Устанавливает необходимые пакеты opkg (lighttpd, ttyd и др.; полный список см. в `scripts/conf.ts`)
2. Создает необходимые директории на устройстве
3. Настраивает lighttpd с прокси
4. Копирует скрипты для запуска/остановки ttyd
5. Перезапускает сервис lighttpd

**Опции:**
- `--ssh-host <IP>` - IP-адрес SSH-хоста (по умолчанию device-addr)
- `--ssh-port <PORT>` - SSH-порт (по умолчанию: 222)
- `--ssh-key <PATH>` - Путь к приватному SSH-ключу (для авторизации по ключу)
- `--http-port <PORT>` - HTTP-порт для backend-сервиса (по умолчанию: 8081)
- `--remote-www-root <PATH>` - Директория для frontend-файлов на устройстве (по умолчанию: `/opt/share/www/`)
- `--ttyd-port <PORT>` - Порт для WebSocket-сервера ttyd (по умолчанию: 7681)
- `--ttyd-scripts-dir <PATH>` - Директория для управляющих скриптов ttyd (по умолчанию: `/opt/etc/ttyd/`)

**Пример:**
```bash
pnpm configure-backend --device-addr 192.168.1.1 --port 7070 --ssh-key ~/.ssh/id_rsa
```

### Развертывание frontend

Загрузите собранный frontend на устройство:

```bash
pnpm deploy-frontend --device-addr <IP_ADDRESS>
```

Этот скрипт:
1. Собирает проект
2. Создает удаленную директорию при необходимости
3. Копирует все файлы из `dist/` на устройство через SCP

**Опции:** такие же, как у скрипта `configure-backend`

**Пример:**
```bash
pnpm deploy-frontend --device-addr 192.168.1.1 --remote-www-root /opt/share/www/
```

## Конфигурация

### Переменные окружения

Вы можете задавать значения для перечисленных выше опций, используя файл `.env`
(имена переменных перечислены в  `.env.template`) или через аргументы командной строки.
Для удобного управления этими значениями можно использовать скрипт `cfg`.

**Показать текущую конфигурацию:**
```bash
pnpm cfg list
```

**Установить значения конфигурации:**
```bash
pnpm cfg set --device-addr 192.168.1.1 --ssh-port 222 --http-port 8081
```

**Удалить значения конфигурации:**
```bash
pnpm cfg delete --device-addr
```

### Доступные параметры конфигурации

| Опция                  | Переменная окружения | Значение по умолчанию | Описание                                     |
|------------------------|----------------------|-----------------------|----------------------------------------------|
| `--device-addr`        | `DEVICE_ADDR`        | -                     | IP-адрес устройства (обязательно)            |
| `--ssh-host`           | `SSH_HOST`           | device-addr           | IP-адрес SSH-хоста                           |
| `--ssh-port`           | `SSH_PORT`           | 222                   | SSH-порт                                     |
| `--ssh-key`            | `SSH_KEY`            | -                     | Путь к приватному SSH-ключу                  |
| `--http-port`          | `HTTP_PORT`          | 8081                  | HTTP-порт для backend-сервиса                |
| `--remote-www-root`    | `REMOTE_WWW_ROOT`    | `/opt/share/www/`     | Директория для frontend-файлов на устройстве |
| `--ttyd-port`          | `TTYD_PORT`          | 7681                  | Порт для WebSocket-сервера ttyd              |
| `--ttyd-scripts-dir`   | `TTYD_SCRIPTS_DIR`   | `/opt/etc/ttyd/`      | Директория для управляющих скриптов ttyd     |

### Аутентификация по SSH

Приложение поддерживает два метода аутентификации:

1. **Аутентификация по SSH-ключу** (требует установки и настройки OpenSSH в opkg):
   ```bash
   pnpm dev --device-addr 192.168.1.1 --ssh-key ~/.ssh/id_rsa
   ```

2. **Аутентификация по паролю**:
   - Требуется установленный `sshpass`
   - При запуске скриптов `configure-backend` и `deploy-frontend` будет запрошен пароль

## Структура проекта

```
sv-webcli/
├── src/
│   ├── api/              # RCI API-сервисы "по команде"
│   ├── components/       # Svelte-компоненты
│   ├── routes/           # Маршруты приложения
│   ├── services/         # Сервисы бизнес-логики
│   ├── state/            # Управление состоянием приложения
│   └── utils/            # Вспомогательные функции
│
├── scripts/
│   ├── configure-backend.ts  # Скрипт развертывания backend
│   ├── deploy-frontend.ts    # Скрипт развертывания frontend
│   ├── dev.ts                # Сервер разработки
│   ├── preview.ts            # Сервер предпросмотра
│   └── opkg/                 # Файлы конфигурации устройства
│
└── dist/                 # Результат сборки для продакшена
```

## Скрипты в `package.json`

| Скрипт                    | Описание                                |
|---------------------------|-----------------------------------------|
| `pnpm dev`                | Запуск сервера разработки с hot reload  |
| `pnpm build`              | Сборка для продакшена                   |
| `pnpm preview`            | Предпросмотр продакшен-сборки           |
| `pnpm check`              | Проверка типов Svelte                   |
| `pnpm fmt`                | Форматирование кода с помощью dprint    |
| `pnpm configure-backend`  | Настройка backend на устройстве         |
| `pnpm deploy-frontend`    | Развертывание frontend на устройстве    |
| `pnpm cfg`                | Управление значениями конфигурации      |
